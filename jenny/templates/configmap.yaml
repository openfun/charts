apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ template "jenny.fullname" . }}-nginx"
data:
  config: |
    # nginx.conf
    user nobody nogroup;
    # 'user nobody nobody;' for systems with 'nobody' as a group instead
    error_log  /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
      worker_connections 1024; # increase if you have lots of clients
      accept_mutex off; # set to 'on' if nginx worker_processes > 1
      # 'use epoll;' to enable for Linux 2.6+
      # 'use kqueue;' to enable for FreeBSD, OSX
    }

    http {
        upstream django_app {
            server localhost:{{ .Values.django.port }};
        }

        server {
            listen {{ .Values.nginx.port }};

            root /usr/share/nginx;
            location / {
              # checks for static file, if not found proxy to app
              try_files $uri @proxy_to_app;
            }

            location @proxy_to_app {
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $host;
                proxy_redirect off;
                proxy_pass http://django_app;
            }
        }

        server {
          listen 5000;
          server_name localhost;

          location /__status__ {
            stub_status;
            allow 127.0.0.1;
            deny all;
            access_log off;
          }

        }

        include /etc/nginx/mime.types;
    }
